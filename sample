-- Sample table creation (you can adapt this to your actual table structure)
CREATE TABLE Transactions (
    FundLaunchDate DATE,  -- Product Live Date
    TradeDate DATE,
    InvestmentType VARCHAR(50),
    TradeType VARCHAR(50),
    InvestmentSource VARCHAR(50),
    BenefitCategory VARCHAR(50),
    TransactionReasonCode VARCHAR(50)
);

-- Sample Insert (This is just for example, your data may vary)
INSERT INTO Transactions (FundLaunchDate, TradeDate, InvestmentType, TradeType, InvestmentSource, BenefitCategory)
VALUES
('2025-02-01', '2025-02-05', 'BuyInvestment', 'buy_monetary', 'Contribution', NULL),
('2025-02-01', '2025-02-10', 'BuyInvestment', 'buy_unit', 'Contribution', NULL),
('2025-02-01', '2025-02-20', 'PhasedSwitchBuyInvestment', 'buy_monetary', NULL, NULL),
('2025-02-01', '2025-02-15', 'PhasedSwitchSellInvestment', 'sell_unit', NULL, NULL),
('2025-02-01', '2025-02-12', 'SellInvestment', 'sell_unit', NULL, 'Full withdrawal'),
('2025-02-01', '2025-02-14', 'SellInvestment', 'sell_monetary', NULL, 'Partial Withdrawal'),
('2025-02-01', '2025-02-11', 'SellInvestment', 'sell_unit', NULL, 'Death'),
('2025-02-01', '2025-02-08', 'SellInvestment', 'sell_monetary', 'Adjustment', NULL);

-- Optionally define Fund Launch Date as a parameter (for the sake of this example, let's use '2025-02-01')
DECLARE @FundLaunchDate DATE = '2025-02-01';

-- Calculate Offset Date (Fund Launch Date + 7 days)
DECLARE @OffsetDate DATE = DATEADD(DAY, 7, @FundLaunchDate);

-- SQL Query to determine the Transaction Reason Code
SELECT 
    FundLaunchDate,
    TradeDate,
    InvestmentType,
    TradeType,
    InvestmentSource,
    BenefitCategory,
    CASE 
        -- Case 1: If Trade Date is before Offset Date, First transaction for all Unique members
        WHEN TradeDate < @OffsetDate THEN 'SNGPRM'
        
        -- Case 2: If Trade Date is after Offset Date, BuyInvestment & Contribution
        WHEN TradeDate >= @OffsetDate
            AND InvestmentType = 'BuyInvestment'
            AND TradeType IN ('buy_monetary', 'buy_unit')
            AND InvestmentSource = 'Contribution' THEN 'REGPRM'
        
        -- Case 3: If Trade Date is after Offset Date, PhasedSwitchBuyInvestment
        WHEN TradeDate >= @OffsetDate
            AND InvestmentType = 'PhasedSwitchBuyInvestment'
            AND TradeType IN ('buy_monetary', 'buy_unit') THEN 'SWCHIN'
        
        -- Case 4: If Trade Date is after Offset Date, PhasedSwitchSellInvestment
        WHEN TradeDate >= @OffsetDate
            AND InvestmentType = 'PhasedSwitchSellInvestment'
            AND TradeType IN ('sell_monetary', 'sell_unit') THEN 'SWCHOU'
        
        -- Case 5: If Trade Date is after Offset Date, SellInvestment with Full withdrawal
        WHEN TradeDate >= @OffsetDate
            AND InvestmentType = 'SellInvestment'
            AND TradeType = 'sell_unit'
            AND BenefitCategory = 'Full withdrawal' THEN 'FUSURR'
        
        -- Case 6: If Trade Date is after Offset Date, SellInvestment with Partial Withdrawal
        WHEN TradeDate >= @OffsetDate
            AND InvestmentType = 'SellInvestment'
            AND TradeType = 'sell_monetary'
            AND BenefitCategory = 'Partial Withdrawal' THEN 'PASURR'
        
        -- Case 7: If Trade Date is after Offset Date, SellInvestment with Death
        WHEN TradeDate >= @OffsetDate
            AND InvestmentType = 'SellInvestment'
            AND TradeType = 'sell_unit'
            AND BenefitCategory = 'Death' THEN 'DEATH'
        
        -- Case 8: If Trade Date is after Offset Date, SellInvestment or BuyInvestment with Adjustment
        WHEN TradeDate >= @OffsetDate
            AND InvestmentType IN ('SellInvestment', 'BuyInvestment')
            AND TradeType IN ('sell_monetary', 'sell_unit', 'buy_monetary', 'buy_unit')
            AND InvestmentSource = 'Adjustment' THEN 'JOURNEY'
        
        -- Default case if no conditions match
        ELSE 'No valid transaction'
    END AS TransactionReasonCode
FROM Transactions;
